---
interface Airport {
  name: string;
  lat: number;
  lng: number;
}

const { airports = [] } = Astro.props;
---

<form id="flight-form" class="flight-form">
  <h2>Create Flight</h2>

  <div class="columns">
    <!-- START -->
    <fieldset class="flight-fieldset">
      <legend>Start</legend>

      <label>
        Airport
        <select id="start-airport">
          <option value="">Custom / None</option>
          {airports.map((a: { name: string; lat: number; lng: number }) => (
            <option value={a.name} data-lat={a.lat} data-lng={a.lng}>
              {a.name}
            </option>
          ))}
        </select>
      </label>

      <label>
        Location name
        <input id="start-name" type="text" placeholder="e.g. London Heathrow" />
      </label>

      <label>
        Latitude
        <input id="start-lat" type="number" step="0.000001" />
      </label>

      <label>
        Longitude
        <input id="start-lng" type="number" step="0.000001" />
      </label>
    </fieldset>

    <!-- END -->
    <fieldset class="flight-fieldset">
      <legend>End</legend>

      <label>
        Airport
        <select id="end-airport">
          <option value="">Custom / None</option>
          {airports.map((a: { name: string; lat: number; lng: number }) => (
            <option value={a.name} data-lat={a.lat} data-lng={a.lng}>
              {a.name}
            </option>
          ))}
        </select>
      </label>

      <label>
        Location name
        <input id="end-name" type="text" placeholder="e.g. Los Angeles Intl." />
      </label>

      <label>
        Latitude
        <input id="end-lat" type="number" step="0.000001" />
      </label>

      <label>
        Longitude
        <input id="end-lng" type="number" step="0.000001" />
      </label>
    </fieldset>
  </div>

  <div class="flight-footer">
    <div id="flight-status" class="flight-status"></div>

    <div class="actions">
      <button type="submit">Create Flight</button>
    </div>
  </div>
</form>

<style>
  .flight-form {
    display: flexbox;
    flex-direction: row;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: rgba(20, 20, 20, 0.75);
    color: #f5f5f5;
    max-width: 800px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(8px);
  }

  .flight-form h2 {
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .flight-fieldset {
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 0.75rem;
    padding: 0.75rem 0.9rem;
    min-width: 0;
  }

  .flight-fieldset legend {
    padding: 0 0.35rem;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
  }

  label {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }

  input,
  select {
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.35rem 0.5rem;
    background: rgba(15, 15, 15, 0.95);
    color: inherit;
    font-size: 0.9rem;
    outline: none;
  }

  input:focus,
  select:focus {
    border-color: #4f9cf9;
  }

  .flight-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-top: 0.25rem;
  }

  .flight-status {
    font-size: 0.8rem;
    color: #d1d5db;
    min-height: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .flight-status.error {
    color: #fecaca;
  }

  .flight-status.success {
    color: #bbf7d0;
  }

  .spinner {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 999px;
    border: 2px solid rgba(209, 213, 219, 0.4);
    border-top-color: #4f9cf9;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .actions {
    display: flex;
    justify-content: flex-end;
  }

  button[type="submit"] {
    border: none;
    border-radius: 999px;
    padding: 0.45rem 1.2rem;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    background: #4f9cf9;
    color: #020617;
  }

  button[type="submit"]:hover:enabled {
    filter: brightness(1.07);
  }

  button[type="submit"]:disabled {
    opacity: 0.6;
    cursor: default;
  }
</style>

<script>
  const startSelect = document.getElementById("start-airport") as HTMLSelectElement | null;
  const endSelect = document.getElementById("end-airport") as HTMLSelectElement | null;

  const startName = document.getElementById("start-name") as HTMLInputElement | null;
  const startLat = document.getElementById("start-lat") as HTMLInputElement | null;
  const startLng = document.getElementById("start-lng") as HTMLInputElement | null;

  const endName = document.getElementById("end-name") as HTMLInputElement | null;
  const endLat = document.getElementById("end-lat") as HTMLInputElement | null;
  const endLng = document.getElementById("end-lng") as HTMLInputElement | null;

  const form = document.getElementById("flight-form") as HTMLFormElement | null;
  const statusEl = document.getElementById("flight-status") as HTMLDivElement | null;
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;

  function applyAirport(
    selectEl: HTMLSelectElement | null,
    nameInput: HTMLInputElement | null,
    latInput: HTMLInputElement | null,
    lngInput: HTMLInputElement | null
  ) {
    if (!selectEl) return;
    const opt = selectEl.selectedOptions[0];
    if (!opt || !opt.dataset.lat) return;

    if (nameInput) nameInput.value = opt.textContent?.trim() ?? "";
    if (latInput) latInput.value = opt.dataset.lat ?? "";
    if (lngInput) lngInput.value = opt.dataset.lng ?? "";
  }

  startSelect?.addEventListener("change", () => {
    applyAirport(startSelect, startName, startLat, startLng);
  });

  endSelect?.addEventListener("change", () => {
    applyAirport(endSelect, endName, endLat, endLng);
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!startName || !startLat || !startLng || !endName || !endLat || !endLng) return;

    const payload = {
      startLatitude: parseFloat(startLat.value),
      startLongitude: parseFloat(startLng.value),
      startLocationName: startName.value.trim(),
      endLatitude: parseFloat(endLat.value),
      endLongitude: parseFloat(endLng.value),
      endLocationName: endName.value.trim(),
    };

    console.log("Sending payload:", payload);

    if (statusEl) {
      statusEl.classList.remove("error", "success");
      statusEl.innerHTML = `<span class="spinner"></span><span>Creating flight...</span>`;
    }
    if (submitBtn) submitBtn.disabled = true;

    try {
      const res = await fetch("http://localhost:8080/api/flights", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        console.error("Error sending create flight request: ", res.status, res.statusText);
        if (statusEl) {
          statusEl.classList.add("error");
          statusEl.textContent = "Failed to create flight.";
        }
        return;
      }

      const data = await res.json();
      console.log("Created flight: ", data);

      if (statusEl) {
        statusEl.classList.add("success");
        statusEl.textContent = `Created flight with id ${data.id}`;
      }

      // Optional: clear or keep the form; up to you
      // form.reset();

      window.dispatchEvent(
        new CustomEvent("flight-create", { detail: data })
      );
    } catch (err) {
      console.error("Request failed:", err);
      if (statusEl) {
        statusEl.classList.add("error");
        statusEl.textContent = "Could not reach backend.";
      }
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
</script>
