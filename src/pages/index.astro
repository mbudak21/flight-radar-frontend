---
import LeafletMap from "../components/LeafletMap.astro";
import DatePicker from "../components/DatePicker";
import Slider from "../components/Slider.astro";
import FlightCreator from "../components/FlightCreator.astro";
import "../styles/global.css";

const API_URL = "http://localhost:8080/api/"

const res = await fetch(API_URL + "airports");
if (!res.ok) {
  console.error("Failed to fetch airports:", res.status, res.statusText);
}
const airports = res.ok ? await res.json() : [];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Flight Map</title>
  </head>

  <body>
    <div class="wrap">
      <div class="date-controls">
        <h1>Flight Map</h1>
        <div class="header-wrapper">
          <button id="flight-creator"></button>
          <DatePicker client:load/>
        </div>

      </div>

      <div class="flight-map-card">
        <LeafletMap/>
      </div>


      <div class="time-controls">
        <Slider/>
      </div>
      <div class="hidden" id="flight-creator-wrapper">
        <FlightCreator airports={airports}/>
      </div>
    </div>

  </body>

</html>

<style is:global>

  .header-wrapper {
    display: flex;
    gap: 1rem;
  }

  .date-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    height: 5rem;
  }

  .flight-map-card {
    flex: 1;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
    box-shadow: 0 9px 20px rgba(0, 0, 0, 0.55);
  }

  .time-controls {
    padding-top: 1rem;
    padding-bottom: 1rem;
 }

  .time-controls .time-slider {
    width: 100%;
    border: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
    box-shadow: 0 9px 20px rgba(0, 0, 0, 0.55);
  }

  #flight-creator {
    appearance: none;
    border: 2px solid rgba(255, 255, 255, 0.12);
    background: rgba(0, 0, 0, 0.852);
    backdrop-filter: blur(8px);

    font-size: ;

    margin-top: 1rem;
    padding: 0.45rem;
    height: 2rem;
    border-radius: 0.65rem;

    color: #e5e7eb;
    display: inline-flex;
    align-items: center;

    cursor: pointer;
    transition:
      border-color 0.2s ease,
      background 0.2s ease,
      transform 0.15s ease,
      filter 0.15s ease;
  }

  #flight-creator::before {
    content: "âœˆ Create Flight"; 
    font-size: 1.2rem;
    opacity: 0.9;
  }

  #flight-creator:hover {
    border-color: rgba(31, 5, 5, 0.608);
    background: rgba(62, 6, 6, 0.776);
    filter: brightness(1.05);
  }

  #flight-creator:active {
    transform: scale(0.96);
  }

  #flight-creator-wrapper {
    position: fixed;
    left: 50%;
    bottom: 0;
    width: fit-content;
    transform: translate(-50%, 100%); /* start below view */
    border-radius: 1rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.55);
    z-index: 1000;
    background: rgba(20, 20, 20, 0.95);

    transition: transform 0.50s ease;
  }

  #flight-creator-wrapper.show {
    transform: translate(-50%, -50%);
  }

  /* Debugging */
  
  /* .date-controls{
    background: red;
  }
  .flight-map-card {
    background: green;
  }
  .time-controls {
    background: yellow;
  }
  .time-controls .time-slider {
    background: purple;
  }
  html{
    background: mediumvioletred;
  } */
</style>

<script>
  import type { FlightMap } from "../lib/FlightMap";
  // Pads numbers, ex: "6" -> "06"
  function pad(n: number) { return String(n).padStart(2, '0'); }

  const now = new Date();

  let currentTime = pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  let currentDate = now.toISOString().split("T")[0];

  function makeDateTimeISO() {
    if (!currentDate || !currentTime) return null;

    const iso = `${currentDate}T${currentTime}`;
    const obj = new Date(iso);

    if (isNaN(obj.getTime())) {
      console.warn("Invalid datetime", iso);
      return null;
    }

    return obj.toISOString();
  }

  async function updateFlights() {
    const iso = makeDateTimeISO();
    if (!iso) return;

    console.log("Fetching flights for:", iso);

    const map = (window as any).flightMap as FlightMap | undefined;
    if (!map) {
      console.warn("flightMap not ready yet");
      return;
    }

    await map.loadFlightsAt(iso);
  }
  
  window.addEventListener("DOMContentLoaded", () => {
    const timeLabel = document.getElementById("time-label");

    if (!timeLabel) {
      console.warn("Time label not found");
      return;
    }

    timeLabel.addEventListener("timechange", (e) => {
      console.log("Current Time:", e.detail.text);
      currentTime = e.detail.text;
      updateFlights();

    });

  });

  window.addEventListener('datechange', (e) => {
    currentDate = e.detail.isoDate;
    console.log('Selected date:', currentDate);
  });

  window.addEventListener('flight-create', (e) => {
    e.payload
  })

  const flightCreateBtn = document.getElementById("flight-creator") as HTMLButtonElement;
  const flightCreateDiv = document.getElementById("flight-creator-wrapper") as HTMLDivElement;
  flightCreateBtn.addEventListener("click", () => {
    flightCreateDiv.classList.toggle("show");
  })

  console.log(makeDateTimeISO());

</script>
